---
import katex from 'katex'
import { mathTree } from '@/data/math-skill-tree'
import type { MathProblemData } from '@/types/math.types'

interface Props {
  data: MathProblemData
  choicesInitiallyOpen?: boolean
}

const { data, choicesInitiallyOpen = false } = Astro.props as Props

const renderMathHtml = (value?: string) =>
  !value || typeof value !== 'string'
    ? value
    : [
        { pattern: /\$\$([\s\S]+?)\$\$/g, displayMode: true },
        { pattern: /\$([^\n]+?)\$/g, displayMode: false }
      ].reduce((output, { pattern, displayMode }) => {
        return output.replace(pattern, (_, expr) => {
          try {
            return katex.renderToString(expr.trim(), { displayMode, throwOnError: false })
          } catch {
            return _
          }
        })
      }, value)

const promptHtml = renderMathHtml(data.promptHtml)
const hintHtml = renderMathHtml(data.hintHtml)
const solutionHtml = renderMathHtml(data.solutionHtml)
const primarySkillId = data.skills.find((s) => s.role === 'primary')?.skillId ?? data.skills[0]?.skillId
const primarySkillLabel = primarySkillId ? mathTree.nodes[primarySkillId]?.label ?? primarySkillId : undefined
---

<article class="math-problem" id={data.id}>
  <header class="math-problem__header">
    <span class="math-problem__eyebrow">
      {`Problem ${data.number.toString().padStart(2, '0')}`}
    </span>

    <div class="math-problem__meta">
      {primarySkillLabel && <span class="meta-label">{primarySkillLabel}</span>}
      {data.difficulty && <span class={`pill pill--${data.difficulty}`}>{data.difficulty}</span>}
    </div>
  </header>

  <div class="math-problem__prompt" set:html={promptHtml} />

  {
    data.choices.length > 0 ? (
      <details class="math-problem__choices-wrapper" open={choicesInitiallyOpen}>
        <summary class="math-problem__choices-toggle">
          <span class="math-problem__choices-toggle-text" data-state="hide">
            Hide choices
          </span>
        <span class="math-problem__choices-toggle-text" data-state="show">
          Show choices
        </span>
        <span class="math-problem__choices-toggle-icon" aria-hidden="true" />
      </summary>

        <div class="math-problem__choices-body">
          <div class="math-problem__choices" role="list">
            {data.choices.map((choice) => (
              <div class="math-problem__choice" role="listitem">
                <span class="math-problem__choice-label">{choice.id}</span>
                <span class="math-problem__choice-text" set:html={renderMathHtml(choice.textHtml)} />
              </div>
            ))}
          </div>
        </div>
      </details>
    ) : (
      <p class="math-problem__empty">No choices provided.</p>
    )
  }

  <div class="math-problem__accordions">
    <details class="math-problem__accordion">
      <summary>
        <span class="math-problem__accordion-label">Hint</span>
        <span class="math-problem__accordion-icon" aria-hidden="true"></span>
      </summary>
      <div class="math-problem__accordion-body">
        <div class="math-problem__accordion-content" set:html={hintHtml} />
      </div>
    </details>

    <details class="math-problem__accordion">
      <summary>
        <span class="math-problem__accordion-label">Solution</span>
        <span class="math-problem__accordion-icon" aria-hidden="true"></span>
      </summary>
      <div class="math-problem__accordion-body">
        <div class="math-problem__accordion-content" set:html={solutionHtml} />
      </div>
    </details>
  </div>
</article>

<script>
  // Smoothly animate details/summary open/close for accordions and choices.
  if (typeof window !== 'undefined') {
    const TRANSITION = `height var(--mp-accordion-duration) var(--mp-accordion-ease), opacity var(--mp-accordion-duration) var(--mp-accordion-ease), transform var(--mp-accordion-duration) var(--mp-accordion-ease)`

    const animateDetails = (details: HTMLDetailsElement, body: HTMLElement, opening: boolean) => {
      details.dataset.animating = 'true'
      const start = body.getBoundingClientRect().height
      if (opening) details.setAttribute('open', '')

      body.style.overflow = 'hidden'
      body.style.transition = 'none'
      body.style.height = `${start}px`
      body.style.opacity = opening ? '0' : '1'
      body.style.transform = opening ? 'translateY(-6px)' : 'translateY(0)'

      requestAnimationFrame(() => {
        body.style.transition = TRANSITION
        body.style.height = opening ? `${body.scrollHeight}px` : '0px'
        body.style.opacity = opening ? '1' : '0'
        body.style.transform = opening ? 'translateY(0)' : 'translateY(-6px)'
      })

      body.addEventListener(
        'transitionend',
        () => {
          body.style.height = ''
          body.style.overflow = ''
          body.style.transition = ''
          details.dataset.animating = ''
          details.dataset.toggling = ''
          if (!opening) details.removeAttribute('open')
        },
        { once: true }
      )
    }

    document
      .querySelectorAll<HTMLDetailsElement>('.math-problem__accordion, .math-problem__choices-wrapper')
      .forEach((details) => {
        const body = details.querySelector<HTMLElement>(
          '.math-problem__accordion-body, .math-problem__choices-body'
        )
        const summary = details.querySelector('summary')
        if (!body || !summary) return

        if (!details.open) {
          body.style.height = '0px'
          body.style.opacity = '0'
          body.style.transform = 'translateY(-6px)'
          body.style.overflow = 'hidden'
        }

        summary.addEventListener('click', (event) => {
          event.preventDefault()
          const opening = !details.open
          // Flip icon immediately by toggling a data flag before we animate height.
          details.dataset.toggling = opening ? 'open' : 'closed'
          if (details.dataset.animating === 'true') return
          animateDetails(details, body, opening)
        })
      })
  }
</script>

<style>
  .math-problem {
    --mp-toggle-icon-size: 1.05rem;
    --mp-toggle-icon-radius: 0.28rem;
    --mp-toggle-gap: 0.4rem;
    --mp-accordion-duration: 0.6s;
    --mp-accordion-ease: cubic-bezier(0.25, 0.85, 0.1, 1);
    position: relative;
    padding: 0.9rem 0.8rem;
    margin: 1.1rem 0 3.2rem;
    border-radius: 0.2rem;
    border: 1px solid var(--border);
    background: var(--code-bg);
    color: var(--text-primary);
  }

  .math-problem__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 0.6rem;
  }

  .math-problem__eyebrow {
    display: inline-flex;
    align-items: center;
    width: fit-content;
    padding: 0.1rem 0.55rem;
    border-radius: 0.45rem;
    border: 1px solid var(--border);
    background: var(--code-bg);
    font-size: 0.75rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-secondary);
  }

  .math-problem__meta {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
    justify-content: flex-end;
    align-items: center;
  }

  .pill,
  .skill-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    border: 1px solid var(--border);
    color: var(--text-secondary);
  }

  .pill {
    padding: 0.05rem 0.4rem;
    border-radius: 0.5rem;
    font-size: 0.72rem;
  }

  .pill--easy {
    color: #3ac277;
  }
  .pill--medium {
    color: #f0b429;
  }
  .pill--hard {
    color: #ff6b6b;
  }
  .pill--easy,
  .pill--medium,
  .pill--hard {
    border-color: currentColor;
  }

  .pill--tag {
    border-color: var(--border);
    font-size: 0.68rem;
    padding: 0.04rem 0.32rem;
  }

  .meta-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    letter-spacing: 0.02em;
  }

  .math-problem__prompt {
    padding: 0.4rem 0.8rem 0.5rem;
    display: grid;
    gap: 0.15rem;
    align-items: start;
    border-radius: 0.2rem;
  }

  :global(.math-problem__prompt p) {
    margin: 0 0 0.5rem;
    line-height: 1.5;
  }

  :global(.math-problem__prompt p:last-child) {
    margin-bottom: 0;
  }

  .math-problem__choices {
    margin: 0;
    padding: 0.1rem 0 0.35rem;
    display: grid;
    gap: 0.4rem;
  }

  .math-problem__choice {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.55rem;
    align-items: center;
    padding: 0.32rem 0.1rem;
  }

  .math-problem__choice-label {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 1.45rem;
    height: 1.45rem;
    border-radius: 0.18rem;
    font-weight: 700;
    letter-spacing: 0.02em;
  }

  .math-problem__choice-text {
    font-weight: 600;
  }

  .math-problem__empty {
    margin: 1.5rem 0 0;
    color: var(--text-secondary);
    font-style: italic;
  }

  .math-problem__accordions {
    display: flex;
    flex-direction: column;
    gap: 0.55rem;
    margin-top: 1rem;
  }

  .math-problem__accordion {
    border-radius: 0.25rem;
    border: 1px solid var(--border);
    background: var(--code-bg);
    padding: 0.05rem 0.35rem;
    transition:
      border-color 0.12s ease,
      background 0.12s ease;
  }

  .math-problem__accordion[open] {
    border-color: var(--text-tertiary);
  }

  .math-problem__accordion summary {
    padding: 0.75rem 0.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--mp-toggle-gap);
    font-weight: 500;
    transition: color 0.2s ease;
  }

  .math-problem__accordion-label {
    padding: 0.05rem 0.1rem;
  }

  .math-problem__accordion-icon,
  .math-problem__choices-toggle-icon {
    display: inline-flex;
    width: var(--mp-toggle-icon-size);
    height: var(--mp-toggle-icon-size);
    align-items: center;
    justify-content: center;
    border-radius: var(--mp-toggle-icon-radius);
    font-weight: 800;
    transition: transform var(--mp-accordion-duration) var(--mp-accordion-ease);
    background: currentColor;
    mask-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='none' stroke='%23000' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 5l8 7-8 7'/></svg>");
    -webkit-mask-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='none' stroke='%23000' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 5l8 7-8 7'/></svg>");
    mask-repeat: no-repeat;
    -webkit-mask-repeat: no-repeat;
    mask-size: contain;
    -webkit-mask-size: contain;
    mask-position: center;
    -webkit-mask-position: center;
  }

  .math-problem__accordion[open] .math-problem__accordion-icon,
  .math-problem__choices-wrapper[open] .math-problem__choices-toggle-icon {
    transform: rotate(90deg);
  }

  .math-problem__accordion[data-toggling='closed'] .math-problem__accordion-icon,
  .math-problem__choices-wrapper[data-toggling='closed'] .math-problem__choices-toggle-icon {
    transform: rotate(0deg);
  }

  .math-problem__accordion-body {
    padding: 0;
    line-height: 1.5;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform: translateY(-6px);
  }

  .math-problem__accordion[open] .math-problem__accordion-body {
    max-height: 1200px;
    opacity: 1;
    transform: translateY(0);
  }

  .math-problem__accordion-content {
    padding: 0.75rem 0.55rem 0.9rem;
    overflow: hidden;
  }

  .math-problem__accordion-body p {
    margin: 0.2rem 0 0.7rem;
  }

  .math-problem__accordion-body p:last-child {
    margin-bottom: 0;
  }

  .math-problem__choices-wrapper {
    margin: 0.25rem 0 0.5rem;
  }

  .math-problem__choices-body {
    overflow: hidden;
    opacity: 0;
    transform: translateY(-6px);
    max-height: 0;
  }

  .math-problem__choices-wrapper[open] .math-problem__choices-body {
    max-height: 1200px;
    opacity: 1;
    transform: translateY(0);
  }

  .math-problem__choices-toggle {
    padding: 0.15rem 0.1rem;
    display: inline-flex;
    align-items: center;
    gap: var(--mp-toggle-gap);
    font-weight: 500;
    color: var(--text-secondary);
  }

  .math-problem__choices-toggle-text {
    display: none;
    font: inherit;
    color: inherit;
  }

  .math-problem__choices-wrapper[data-toggling='open'] .math-problem__choices-toggle-text[data-state='hide'],
  .math-problem__choices-wrapper[open]:not([data-toggling='closed'])
    .math-problem__choices-toggle-text[data-state='hide'],
  .math-problem__choices-wrapper[data-toggling='closed']
    .math-problem__choices-toggle-text[data-state='show'],
  .math-problem__choices-wrapper:not([open]):not([data-toggling='open'])
    .math-problem__choices-toggle-text[data-state='show'] {
    display: inline-flex;
  }

  .math-problem__choices-toggle-icon::before {
    content: 'âˆ’';
  }

  .math-problem__choices-wrapper:not([open]) .math-problem__choices-toggle-icon::before {
    content: '+';
  }

  .math-problem__accordion summary,
  .math-problem__choices-toggle {
    cursor: pointer;
    list-style: none;
    border: none;
    background: transparent;
  }

  .math-problem__accordion summary::-webkit-details-marker,
  .math-problem__choices-toggle::-webkit-details-marker {
    display: none;
  }

  @media (max-width: 640px) {
    .math-problem {
      padding: 1rem 0.9rem;
    }

    .math-problem__choice {
      grid-template-columns: 2.25rem 1fr;
    }
  }
</style>
